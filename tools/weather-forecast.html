<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能天气助手</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-radius: 20px;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .weather-header {
            background: var(--primary-gradient);
            padding: 2rem 0;
            border-radius: 0 0 40px 40px;
        }

        .weather-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .weather-card:hover {
            transform: translateY(-5px);
        }

        .map-container {
            height: 400px;
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .temp-display {
            font-size: 4rem;
            font-weight: 300;
            line-height: 1;
        }

        .weather-icon {
            width: 100px;
            height: 100px;
            margin: -1rem 0;
        }

        @media (max-width: 768px) {
            .temp-display {
                font-size: 3rem;
            }
            .weather-icon {
                width: 80px;
                height: 80px;
            }
        }

        /* 新增动画样式 */
        .weather-animation {
            position: relative;
            height: 120px;
            overflow: hidden;
        }
        
        /* 晴天动画 */
        .sunny-animation::after {
            content: "☀️";
            position: absolute;
            font-size: 80px;
            animation: sunRotate 20s linear infinite;
        }

        @keyframes sunRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 雨天动画 */
        .rainy-animation::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><line x1="20" y1="0" x2="20" y2="20" stroke="%2300B4FF" stroke-width="2"/></svg>') repeat;
            animation: rainFall 0.5s linear infinite;
        }

        @keyframes rainFall {
            from { transform: translateY(-100%); }
            to { transform: translateY(100%); }
        }

        /* 预警通知 */
        .alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff4444;
            color: white;
            padding: 1rem;
            z-index: 1000;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* 历史记录 */
        .search-history {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <div class="weather-header">
        <div class="container">
            <div class="d-flex flex-column flex-md-row align-items-center justify-content-between text-white">
                <h1 class="mb-3 mb-md-0">智能天气助手</h1>
                <div class="d-flex gap-2 w-100 w-md-auto">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="输入城市名称" id="cityInput">
                        <button class="btn btn-light" onclick="showCityWeather()">
                            <i class="mdi mdi-magnify"></i>
                        </button>
                    </div>
                    <button class="btn btn-light" onclick="getLocation()">
                        <i class="mdi mdi-crosshairs-gps"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- 当前天气 -->
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="weather-card">
                    <div class="weather-animation" id="weatherAnimation"></div>
                    <div class="d-flex flex-column flex-md-row align-items-center text-center text-md-start">
                        <div class="me-md-4">
                            <div class="temp-display">24°C</div>
                            <div class="h4 mb-3">北京</div>
                            <div class="text-muted">2023年10月15日 15:30</div>
                        </div>
                        <img src="https://openweathermap.org/img/wn/01d@2x.png" class="weather-icon">
                        <div class="ms-md-4 mt-3 mt-md-0">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <i class="mdi mdi-water-percent"></i>
                                        湿度 65%
                                    </div>
                                    <div class="mb-2">
                                        <i class="mdi mdi-weather-windy"></i>
                                        风速 3m/s
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <i class="mdi mdi-thermometer"></i>
                                        体感 26°C
                                    </div>
                                    <div class="mb-2">
                                        <i class="mdi mdi-gauge"></i>
                                        气压 1015hPa
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 地图容器 -->
            <div class="col-lg-4">
                <div class="weather-card p-0">
                    <div class="map-container" id="map"></div>
                </div>
            </div>
        </div>

        <!-- 小时预报 -->
        <h4 class="my-4"><i class="mdi mdi-clock-outline"></i> 24小时预报</h4>
        <div class="row g-3" id="hourlyForecast">
            <!-- 示例数据 -->
            <div class="col-6 col-md-4 col-lg-2">
                <div class="weather-card text-center py-3">
                    <div class="h5">15:00</div>
                    <img src="https://openweathermap.org/img/wn/01d@2x.png" width="60">
                    <div class="h4 mt-2">24°C</div>
                </div>
            </div>
            <!-- 更多小时数据... -->
        </div>

        <!-- 7天预报 -->
        <h4 class="my-4"><i class="mdi mdi-calendar"></i> 7天预报</h4>
        <div class="row g-3" id="dailyForecast">
            <!-- 示例数据 -->
            <div class="col-12">
                <div class="weather-card">
                    <div class="row align-items-center">
                        <div class="col-3">周一</div>
                        <div class="col-2"><img src="https://openweathermap.org/img/wn/01d@2x.png" width="50"></div>
                        <div class="col-4">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: 60%"></div>
                            </div>
                        </div>
                        <div class="col-3 text-end">18°C / 26°C</div>
                    </div>
                </div>
            </div>
            <!-- 更多天数... -->
        </div>

        <!-- 添加温度趋势图表 -->
        <div class="weather-card">
            <canvas id="temperatureChart"></canvas>
        </div>

        <!-- 在搜索框下方添加历史记录 -->
        <div class="position-relative">
            <div class="search-history card d-none" id="searchHistory"></div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script>
        // 新增功能实现
        let chart;

        // 初始化IP定位
        async function initGeoLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                searchWeatherByCoords(data.latitude, data.longitude);
                document.getElementById('cityInput').value = data.city;
            } catch (error) {
                console.log('IP定位失败，使用默认位置');
            }
        }

        // 更新天气UI时添加动画
        function updateWeatherUI(data) {
            // 设置天气动画
            const animationContainer = document.getElementById('weatherAnimation');
            animationContainer.className = 'weather-animation ' + getWeatherAnimationClass(data.current.weather[0].main);
            
            // 更新温度图表
            updateTemperatureChart(data.hourly);
            
            // 保存到历史记录
            saveToHistory(data.city);
            
            // 检查天气预警
            checkWeatherAlerts(data.alerts);
        }

        // 获取天气动画类名
        function getWeatherAnimationClass(weather) {
            const map = {
                Clear: 'sunny-animation',
                Rain: 'rainy-animation',
                Clouds: 'cloudy-animation',
                Snow: 'snow-animation'
            };
            return map[weather] || '';
        }

        // 温度趋势图表
        function updateTemperatureChart(hourlyData) {
            const ctx = document.getElementById('temperatureChart').getContext('2d');
            
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hourlyData.slice(0, 24).map(h => new Date(h.dt * 1000).getHours() + '时'),
                    datasets: [{
                        label: '温度趋势',
                        data: hourlyData.slice(0, 24).map(h => h.temp),
                        borderColor: '#667eea',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // 本地存储历史记录
        function saveToHistory(city) {
            const history = JSON.parse(localStorage.getItem('weatherHistory') || '[]');
            const newHistory = _.uniq([city, ...history]).slice(0, 5);
            localStorage.setItem('weatherHistory', JSON.stringify(newHistory));
            renderHistory(newHistory);
        }

        function renderHistory(history) {
            const container = document.getElementById('searchHistory');
            container.innerHTML = history.map(city => `
                <div class="list-group-item clickable" onclick="searchWeather('${city}')">
                    ${city}
                </div>
            `).join('');
        }

        // 天气预警通知
        function checkWeatherAlerts(alerts) {
            const container = document.getElementById('weatherAlerts');
            container.innerHTML = alerts ? alerts.map(alert => `
                <div class="alert-banner">
                    ⚠️ ${alert.event}: ${alert.description} (${new Date(alert.start * 1000).toLocaleString()})
                </div>
            `).join('') : '';
        }

        // 初始化时加载历史记录和定位
        document.addEventListener('DOMContentLoaded', () => {
            initGeoLocation();
            renderHistory(JSON.parse(localStorage.getItem('weatherHistory') || '[]'));
            
            // 显示/隐藏历史记录
            document.getElementById('cityInput').addEventListener('focus', () => {
                document.getElementById('searchHistory').classList.remove('d-none');
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#cityInput')) {
                    document.getElementById('searchHistory').classList.add('d-none');
                }
            });
        });

        // 修改后的搜索函数
        async function searchWeather(city) {
            // 保持原有逻辑，增加错误处理
            try {
                // ... 原有代码 ...
            } catch (error) {
                showError('获取天气数据失败');
            }
        }

        // 模拟数据功能
        function showCityWeather() {
            const city = document.getElementById('cityInput').value;
            if (!city) return;
            
            // 显示加载状态
            document.body.classList.add('loading');
            
            // 模拟API请求延迟
            setTimeout(() => {
                updateWeatherUI(getSampleData());
                initMap(39.9042, 116.4074); // 北京坐标
                document.body.classList.remove('loading');
            }, 500);
        }

        function getSampleData() {
            return {
                current: {
                    temp: 24,
                    humidity: 65,
                    wind_speed: 3,
                    feels_like: 26,
                    pressure: 1015
                }
            };
        }

        // 地图初始化
        function initMap(lat = 39.9042, lon = 116.4074) {
            if (typeof L === 'undefined') return;
            
            const mapElement = document.getElementById('map');
            if (mapElement._leaflet_map) return;

            const map = L.map('map').setView([lat, lon], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            L.marker([lat, lon]).addTo(map)
                .bindPopup('当前位置')
                .openPopup();
        }

        // 初始加载
        initMap();
    </script>
</body>
</html> 