<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务清单 - 工具箱</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .task-card { transition: transform 0.2s; }
        .priority-high { border-left: 4px solid #dc3545; }
        .priority-medium { border-left: 4px solid #ffc107; }
        .priority-low { border-left: 4px solid #0dcaf0; }
        .tag-badge { font-size: 0.85rem; }
        .chart-container { height: 300px; }
    </style>
</head>
<body class="bg-light">
    <!-- 统一导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-tools me-2"></i>工具箱
            </a>
            <!-- 导航菜单项 -->
        </div>
    </nav>

    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="mb-3"><i class="bi bi-list-task me-2 text-primary"></i>智能任务清单</h1>
                <p class="lead">高效管理每日任务，智能规划工作流程</p>
                <!-- 面包屑导航 -->
            </div>
        </div>

        <!-- 任务创建区 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form id="taskForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="taskTitle" placeholder="输入任务内容" required>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="taskPriority">
                                <option value="3">高优先级</option>
                                <option value="2">中优先级</option>
                                <option value="1">低优先级</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-circle me-2"></i>添加任务
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="taskTags" placeholder="添加标签（用逗号分隔）">
                        </div>
                        <div class="col-md-3">
                            <input type="datetime-local" class="form-control" id="taskDueDate">
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 任务列表区 -->
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="搜索任务...">
                </div>
                <div id="taskList" class="mb-4">
                    <!-- 任务动态加载 -->
                </div>
            </div>
            
            <!-- 统计面板 -->
            <div class="col-md-4">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>任务统计</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="taskChart" class="chart-container"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 任务数据结构和本地存储
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let notificationsEnabled = Notification.permission === 'granted';
        
        // 初始化图表
        const chartCtx = document.getElementById('taskChart').getContext('2d');
        let taskChart = new Chart(chartCtx, {
            type: 'line',
            data: {
                labels: Array.from({length:7}, (_,i) => `${i+1}日前`),
                datasets: [{
                    label: '完成任务趋势',
                    data: Array(7).fill(0),
                    borderColor: '#4caf50',
                    tension: 0.4
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 表单提交处理
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newTask = {
                id: Date.now(),
                title: document.getElementById('taskTitle').value,
                priority: parseInt(document.getElementById('taskPriority').value),
                tags: document.getElementById('taskTags').value.split(',').map(t => t.trim()),
                dueDate: document.getElementById('taskDueDate').value,
                completed: false,
                createdAt: new Date().toISOString()
            };
            tasks.push(newTask);
            updateTasks();
            this.reset();
        });

        // 更新任务列表和统计
        function updateTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderTasks();
            updateChart();
            checkDueTasks();
            syncWithPomodoro();
        }

        // 渲染任务列表
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = tasks.map(task => `
                <div class="card mb-2 task-card priority-${getPriorityClass(task.priority)}">
                    <div class="card-body d-flex align-items-center">
                        <div class="form-check flex-grow-1">
                            <input type="checkbox" class="form-check-input" ${task.completed ? 'checked' : ''} 
                                onchange="toggleTask(${task.id})">
                            <label class="form-check-label ${task.completed ? 'text-muted text-decoration-line-through' : ''}">
                                ${task.title}
                                ${task.tags.map(t => `<span class="badge bg-secondary tag-badge ms-2">${t}</span>`).join('')}
                            </label>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    ${task.dueDate ? `<div class="card-footer text-muted small">
                        截止时间：${new Date(task.dueDate).toLocaleString()}
                    </div>` : ''}
                </div>
            `).join('');
        }

        // 新增功能函数
        function initNotifications() {
            if (!notificationsEnabled) {
                Notification.requestPermission().then(permission => {
                    notificationsEnabled = permission === 'granted';
                });
            }
        }

        function checkDueTasks() {
            tasks.forEach(task => {
                if (!task.completed && task.dueDate) {
                    const dueTime = new Date(task.dueDate).getTime();
                    const now = Date.now();
                    if (dueTime - now < 3600000) { // 1小时内到期
                        new Notification(`任务即将到期: ${task.title}`, {
                            body: `剩余时间: ${Math.ceil((dueTime - now)/60000)}分钟`
                        });
                    }
                }
            });
        }

        function syncWithPomodoro() {
            const completedTasks = tasks.filter(t => t.completed);
            if (completedTasks.length % 3 === 0 && completedTasks.length > 0) {
                localStorage.setItem('pomodoroAutoStart', 'true');
            }
        }

        function setupSearch() {
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                tasks.forEach(task => {
                    const element = document.getElementById(`task-${task.id}`);
                    if (element) {
                        element.style.display = task.title.toLowerCase().includes(term) ? 'block' : 'none';
                    }
                });
            });
        }

        // 辅助函数
        function getPriorityClass(priority) {
            return ['low', 'medium', 'high'][priority - 1];
        }

        function toggleTask(id) {
            tasks = tasks.map(task => 
                task.id === id ? {...task, completed: !task.completed} : task
            );
            updateTasks();
        }

        function deleteTask(id) {
            tasks = tasks.filter(task => task.id !== id);
            updateTasks();
        }

        function updateChart() {
            const completed = tasks.filter(t => t.completed).length;
            const inProgress = tasks.filter(t => !t.completed && t.dueDate).length;
            taskChart.data.datasets[0].data = [
                completed,
                inProgress,
                tasks.length - completed - inProgress
            ];
            taskChart.update();
        }

        // 初始化渲染
        initNotifications();
        renderTasks();
        updateChart();
        setupSearch();
    </script>
</body>
</html>