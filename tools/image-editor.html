<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片编辑 - 工具箱</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-tools me-2"></i>工具箱
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#popular">热门工具</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#all-tools">全部工具</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="mb-3"><i class="bi bi-pencil-square me-2 text-primary"></i>图片编辑</h1>
                <p class="lead">在线编辑图片，支持裁剪、旋转、滤镜等操作</p>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html">首页</a></li>
                        <li class="breadcrumb-item"><a href="../index.html#多媒体处理">多媒体处理</a></li>
                        <li class="breadcrumb-item active" aria-current="page">图片编辑</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-4 text-end">
                <div class="tool-icons mt-md-4">
                    <span class="badge rounded-pill bg-primary me-2">
                        <i class="bi bi-image me-1"></i> 图像处理
                    </span>
                    <span class="badge rounded-pill bg-success me-2">
                        <i class="bi bi-cloud-arrow-up me-1"></i> 本地处理
                    </span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">上传图片</h5>
                        <div class="mb-4">
                            <div class="upload-area p-5 text-center border rounded mb-3" id="dropArea">
                                <i class="bi bi-cloud-arrow-up display-4 text-primary mb-3"></i>
                                <p class="mb-2">拖放图片到这里或点击下方按钮选择</p>
                                <p class="text-muted mb-3">支持JPG、PNG、WebP等格式，最大20MB</p>
                                <input type="file" id="imageInput" accept="image/*" class="d-none">
                                <button class="btn btn-primary" id="uploadBtn">
                                    <i class="bi bi-plus-circle me-2"></i>选择图片
                                </button>
                            </div>
                        </div>

                        <div class="canvas-container mb-4">
                            <canvas id="editorCanvas" class="border rounded"></canvas>
                        </div>

                        <div class="edit-toolbar mb-3">
                            <button class="btn btn-outline-primary me-2" id="cropBtn">
                                <i class="bi bi-crop"></i> 裁剪
                            </button>
                            <button class="btn btn-outline-primary me-2" id="rotateLeftBtn">
                                <i class="bi bi-arrow-counterclockwise"></i> 左旋
                            </button>
                            <button class="btn btn-outline-primary me-2" id="rotateRightBtn">
                                <i class="bi bi-arrow-clockwise"></i> 右旋
                            </button>
                            <select class="form-select me-2 d-inline-block w-auto" id="filterSelect">
                                <option value="none">选择滤镜</option>
                                <option value="grayscale">黑白</option>
                                <option value="sepia">怀旧</option>
                                <option value="invert">反色</option>
                            </select>
                        </div>

                        <div class="history-controls mb-4">
                            <button class="btn btn-secondary me-2" id="undoBtn" disabled>
                                <i class="bi bi-arrow-counterclockwise"></i> 撤销
                            </button>
                            <button class="btn btn-secondary" id="redoBtn" disabled>
                                <i class="bi bi-arrow-clockwise"></i> 重做
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">导出设置</h5>
                        <div class="mb-3">
                            <label class="form-label">图片格式</label>
                            <select class="form-select" id="exportFormat">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                                <option value="webp">WebP</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">图片质量</label>
                            <input type="range" class="form-range" id="qualityRange" min="0" max="1" step="0.1" value="0.8">
                            <div class="text-muted small">当前质量：<span id="qualityValue">80%</span></div>
                        </div>
                        <button class="btn btn-success w-100" id="exportBtn">
                            <i class="bi bi-download me-2"></i>导出图片
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <!-- 页脚内容与image-compress.html保持一致 -->
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // 初始化Canvas和状态
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        let currentImage = null;
        let editHistory = [];
        let currentStep = -1;
    
        // 图片上传处理（与image-compress.html保持一致）
        document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('imageInput').click());
        
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    currentImage = img;
                    saveState();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    
        // 编辑功能实现
        // 裁剪功能实现
        let isCropping = false;
        let cropStartX = 0;
        let cropStartY = 0;
        let cropEndX = 0;
        let cropEndY = 0;

        canvas.addEventListener('mousedown', (e) => {
            if (document.getElementById('cropBtn').classList.contains('active')) {
                isCropping = true;
                const rect = canvas.getBoundingClientRect();
                cropStartX = e.clientX - rect.left;
                cropStartY = e.clientY - rect.top;
                cropEndX = cropStartX;
                cropEndY = cropStartY;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isCropping) {
                const rect = canvas.getBoundingClientRect();
                cropEndX = e.clientX - rect.left;
                cropEndY = e.clientY - rect.top;
                drawCropPreview();
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (isCropping) {
                isCropping = false;
                applyCrop();
                saveState();
            }
        });

        document.getElementById('cropBtn').addEventListener('click', function() {
            this.classList.toggle('active');
            canvas.style.cursor = this.classList.contains('active') ? 'crosshair' : 'default';
        });

        function drawCropPreview() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0);
            
            // 绘制半透明遮罩
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 清除选区区域
            ctx.clearRect(
                Math.min(cropStartX, cropEndX),
                Math.min(cropStartY, cropEndY),
                Math.abs(cropEndX - cropStartX),
                Math.abs(cropEndY - cropStartY)
            );
            
            // 绘制选区边框
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                Math.min(cropStartX, cropEndX) + 1,
                Math.min(cropStartY, cropEndY) + 1,
                Math.abs(cropEndX - cropStartX) - 2,
                Math.abs(cropEndY - cropStartY) - 2
            );
            
            // 绘制辅助线
            ctx.beginPath();
            ctx.moveTo((cropStartX + cropEndX)/2, Math.min(cropStartY, cropEndY));
            ctx.lineTo((cropStartX + cropEndX)/2, Math.max(cropStartY, cropEndY));
            ctx.moveTo(Math.min(cropStartX, cropEndX), (cropStartY + cropEndY)/2);
            ctx.lineTo(Math.max(cropStartX, cropEndX), (cropStartY + cropEndY)/2);
            ctx.strokeStyle = '#ffffff60';
            ctx.stroke();
        }

        function applyCrop() {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = Math.min(cropStartX, cropEndX) * scaleX;
            const y = Math.min(cropStartY, cropEndY) * scaleY;
            const width = Math.abs(cropEndX - cropStartX) * scaleX;
            const height = Math.abs(cropEndY - cropStartY) * scaleY;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            tempCtx.drawImage(canvas, x, y, width, height, 0, 0, width, height);
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(tempCanvas, 0, 0);
            currentImage = new Image();
            currentImage.src = canvas.toDataURL();
            document.getElementById('cropBtn').classList.remove('active');
        }
        document.getElementById('rotateLeftBtn').addEventListener('click', () => rotateImage(-90));
        document.getElementById('rotateRightBtn').addEventListener('click', () => rotateImage(90));
        document.getElementById('filterSelect').addEventListener('change', applyFilter);
    
        // 旋转函数
        function rotateImage(degrees) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvas.height;
            tempCanvas.height = canvas.width;
            
            tempCtx.translate(tempCanvas.width/2, tempCanvas.height/2);
            tempCtx.rotate(degrees * Math.PI / 180);
            tempCtx.drawImage(canvas, -canvas.width/2, -canvas.height/2);
            
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            saveState();
        }
    
        // 滤镜应用
        function applyFilter() {
            const filter = document.getElementById('filterSelect').value;
            ctx.filter = 'none';
            
            switch(filter) {
                case 'grayscale': ctx.filter = 'grayscale(1)'; break;
                case 'sepia': ctx.filter = 'sepia(1)'; break;
                case 'invert': ctx.filter = 'invert(1)'; break;
            }
            
            ctx.drawImage(currentImage, 0, 0);
            currentImage = new Image();
            currentImage.src = canvas.toDataURL();
            saveState();
        }
    
        // 历史状态管理（与image-compress.html的撤销机制类似）
        function saveState() {
            const state = canvas.toDataURL();
            editHistory = editHistory.slice(0, currentStep + 1);
            editHistory.push(state);
            currentStep++;
            updateUndoRedoButtons();
        }
    
        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = currentStep <= 0;
            document.getElementById('redoBtn').disabled = currentStep >= editHistory.length - 1;
        }
    
        document.getElementById('undoBtn').addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                restoreState();
            }
        });
    
        document.getElementById('redoBtn').addEventListener('click', () => {
            if (currentStep < editHistory.length - 1) {
                currentStep++;
                restoreState();
            }
        });
    
        function restoreState() {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                updateUndoRedoButtons();
            };
            img.src = editHistory[currentStep];
        }
    
        // 导出功能（与image-compress.html导出逻辑一致）
        document.getElementById('exportBtn').addEventListener('click', function() {
            const format = document.getElementById('exportFormat').value;
            const quality = parseFloat(document.getElementById('qualityRange').value);
            
            canvas.toBlob(function(blob) {
                const link = document.createElement('a');
                link.download = `edited_image.${format}`;
                link.href = URL.createObjectURL(blob);
                link.click();
            }, `image/${format}`, quality);
        });
    </script>
</body>
</html>