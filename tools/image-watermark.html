<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片水印工具 - 工具箱</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        .image-thumbnail {
            width: 150px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .image-preview-container {
            position: relative;
            margin-bottom: 15px;
        }
        .image-actions {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .canvas-container {
            max-width: 100%;
            overflow: auto;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        #previewCanvas {
            max-width: 100%;
            margin: 0 auto;
            display: block;
        }
        .watermark-container {
            position: relative;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .position-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 5px;
            margin-bottom: 15px;
        }
        .position-option {
            width: 40px;
            height: 40px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
        }
        .position-option.selected {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #dee2e6;
            vertical-align: middle;
            margin-right: 5px;
        }
        .batch-progress {
            height: 25px;
            font-size: 0.8rem;
        }
        .image-item {
            position: relative;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            transition: all 0.3s;
        }
        .image-item:hover {
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .watermark-preview {
            position: absolute;
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-tools me-2"></i>工具箱
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#popular">热门工具</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#all-tools">全部工具</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="mb-3"><i class="bi bi-image me-2 text-primary"></i>图片水印工具</h1>
                <p class="lead">批量给图片添加文字或图片水印，支持自定义位置、透明度和样式</p>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html">首页</a></li>
                        <li class="breadcrumb-item"><a href="../index.html#多媒体处理">多媒体处理</a></li>
                        <li class="breadcrumb-item active" aria-current="page">图片水印工具</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-4 text-end">
                <div class="tool-icons mt-md-4">
                    <span class="badge rounded-pill bg-primary me-2">
                        <i class="bi bi-image me-1"></i> 图像处理
                    </span>
                    <span class="badge rounded-pill bg-success me-2">
                        <i class="bi bi-cloud-arrow-up me-1"></i> 本地处理
                    </span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- 上传区域 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="bi bi-cloud-upload me-2"></i>上传图片</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area p-5 text-center" id="dropArea">
                            <i class="bi bi-images display-4 text-primary mb-3"></i>
                            <p class="mb-2">拖放图片到这里或点击下方按钮选择</p>
                            <p class="text-muted mb-3">支持单张或多张JPG、PNG、WebP等格式图片，每张最大10MB</p>
                            <input type="file" id="imageInput" accept="image/*" multiple class="d-none">
                            <button class="btn btn-primary" id="uploadBtn">
                                <i class="bi bi-plus-circle me-2"></i>选择图片
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 图片预览区 -->
                <div class="card mb-4" id="imagesContainer" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="bi bi-images me-2"></i>已上传图片 (<span id="imageCount">0</span>)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="imagesList">
                            <!-- 图片列表将在这里动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 预览区 -->
                <div class="card mb-4" id="previewContainer" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="bi bi-eye me-2"></i>效果预览</h5>
                    </div>
                    <div class="card-body">
                        <div class="canvas-container">
                            <canvas id="previewCanvas"></canvas>
                        </div>
                        <div class="row">
                            <div class="col">
                                <select class="form-select" id="previewSelector">
                                    <option value="">选择预览图片...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- 水印设置 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="bi bi-sliders me-2"></i>水印设置</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs mb-3" id="watermarkTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-content" type="button" role="tab">
                                    <i class="bi bi-type me-1"></i>文字水印
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-content" type="button" role="tab">
                                    <i class="bi bi-image me-1"></i>图片水印
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="watermarkTabContent">
                            <!-- 文字水印设置 -->
                            <div class="tab-pane fade show active" id="text-content" role="tabpanel">
                                <div class="mb-3">
                                    <label for="watermarkText" class="form-label">水印文字</label>
                                    <input type="text" class="form-control" id="watermarkText" value="版权所有 © 2024" placeholder="请输入水印文字">
                                </div>
                                <div class="mb-3">
                                    <label for="textSize" class="form-label">文字大小</label>
                                    <div class="input-group">
                                        <input type="range" class="form-range" id="textSize" min="10" max="80" value="24">
                                        <span class="ms-2" id="textSizeValue">24px</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="fontFamily" class="form-label">字体</label>
                                    <select class="form-select" id="fontFamily">
                                        <option value="Arial">Arial</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="微软雅黑" selected>微软雅黑</option>
                                        <option value="宋体">宋体</option>
                                        <option value="黑体">黑体</option>
                                        <option value="楷体">楷体</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="textColor" class="form-label">
                                        <span class="color-preview" id="colorPreview" style="background-color: rgba(255, 255, 255, 0.7);"></span>文字颜色
                                    </label>
                                    <input type="color" class="form-control form-control-color" id="textColor" value="#ffffff">
                                </div>
                                <div class="mb-3">
                                    <label for="textOpacity" class="form-label">不透明度</label>
                                    <div class="input-group">
                                        <input type="range" class="form-range" id="textOpacity" min="0.1" max="1.0" step="0.1" value="0.7">
                                        <span class="ms-2" id="textOpacityValue">70%</span>
                                    </div>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="textShadow" checked>
                                    <label class="form-check-label" for="textShadow">添加文字阴影</label>
                                </div>
                            </div>
                            
                            <!-- 图片水印设置 -->
                            <div class="tab-pane fade" id="image-content" role="tabpanel">
                                <div class="mb-3">
                                    <label for="watermarkImageInput" class="form-label">选择水印图片</label>
                                    <input type="file" class="form-control" id="watermarkImageInput" accept="image/*">
                                </div>
                                <div class="mb-3 text-center" id="watermarkImagePreview" style="display: none;">
                                    <img src="" alt="水印预览" class="img-fluid mb-2" style="max-height: 100px;">
                                    <button class="btn btn-sm btn-danger" id="removeWatermarkImage">删除</button>
                                </div>
                                <div class="mb-3">
                                    <label for="imageOpacity" class="form-label">不透明度</label>
                                    <div class="input-group">
                                        <input type="range" class="form-range" id="imageOpacity" min="0.1" max="1.0" step="0.1" value="0.5">
                                        <span class="ms-2" id="imageOpacityValue">50%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="imageSize" class="form-label">图片大小</label>
                                    <div class="input-group">
                                        <input type="range" class="form-range" id="imageSize" min="5" max="50" value="20">
                                        <span class="ms-2" id="imageSizeValue">20%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- 通用设置 -->
                        <div class="mb-3">
                            <label class="form-label">水印位置</label>
                            <div class="position-selector">
                                <div class="position-option" data-position="topLeft"><i class="bi bi-arrow-up-left"></i></div>
                                <div class="position-option" data-position="topCenter"><i class="bi bi-arrow-up"></i></div>
                                <div class="position-option" data-position="topRight"><i class="bi bi-arrow-up-right"></i></div>
                                <div class="position-option" data-position="middleLeft"><i class="bi bi-arrow-left"></i></div>
                                <div class="position-option selected" data-position="center"><i class="bi bi-dot"></i></div>
                                <div class="position-option" data-position="middleRight"><i class="bi bi-arrow-right"></i></div>
                                <div class="position-option" data-position="bottomLeft"><i class="bi bi-arrow-down-left"></i></div>
                                <div class="position-option" data-position="bottomCenter"><i class="bi bi-arrow-down"></i></div>
                                <div class="position-option" data-position="bottomRight"><i class="bi bi-arrow-down-right"></i></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="watermarkMargin" class="form-label">边距</label>
                            <div class="input-group">
                                <input type="range" class="form-range" id="watermarkMargin" min="0" max="100" value="20">
                                <span class="ms-2" id="watermarkMarginValue">20px</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="watermarkRotation" class="form-label">旋转角度</label>
                            <div class="input-group">
                                <input type="range" class="form-range" id="watermarkRotation" min="-45" max="45" value="0">
                                <span class="ms-2" id="watermarkRotationValue">0°</span>
                            </div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="tileModeEnabled">
                            <label class="form-check-label" for="tileModeEnabled">平铺模式 (全图重复水印)</label>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="maintainAspectRatio" checked>
                            <label class="form-check-label" for="maintainAspectRatio">保持原始分辨率</label>
                        </div>
                        
                        <button class="btn btn-primary w-100 mb-3" id="applyWatermarkBtn">
                            <i class="bi bi-brush me-2"></i>应用水印
                        </button>
                    </div>
                </div>
                
                <!-- 导出设置 -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0"><i class="bi bi-download me-2"></i>导出设置</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="fileFormat" class="form-label">文件格式</label>
                            <select class="form-select" id="fileFormat">
                                <option value="jpeg">JPEG</option>
                                <option value="png" selected>PNG</option>
                                <option value="webp">WebP</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="outputQuality" class="form-label">导出质量</label>
                            <div class="input-group">
                                <input type="range" class="form-range" id="outputQuality" min="0.5" max="1.0" step="0.1" value="0.9">
                                <span class="ms-2" id="outputQualityValue">90%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="fileNamePrefix" class="form-label">文件名前缀</label>
                            <input type="text" class="form-control" id="fileNamePrefix" value="watermarked_">
                        </div>
                        <button class="btn btn-success w-100" id="downloadAllBtn" disabled>
                            <i class="bi bi-download me-2"></i>批量下载
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 批量处理进度 -->
        <div class="card mb-4" id="progressContainer" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i>处理进度</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3 batch-progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressStatus" class="text-center">准备处理 <span id="processedCount">0</span>/<span id="totalCount">0</span> 张图片</div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>关于此工具</h5>
                    <p>本工具提供批量图片水印添加功能，可以添加文字或图片水印，所有处理在本地完成，不会上传您的图片到服务器。</p>
                </div>
                <div class="col-md-6">
                    <h5>隐私说明</h5>
                    <p>我们重视您的隐私。所有图片处理均在您的浏览器中进行，不会上传到任何服务器。</p>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p class="mb-0">© 2024 工具箱. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化Bootstrap组件
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // 全局变量
            const images = [];
            let currentPreviewIndex = -1;
            let watermarkImage = null;
            
            // DOM元素引用
            const dropArea = document.getElementById('dropArea');
            const imageInput = document.getElementById('imageInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const imagesContainer = document.getElementById('imagesContainer');
            const imagesList = document.getElementById('imagesList');
            const imageCount = document.getElementById('imageCount');
            const previewContainer = document.getElementById('previewContainer');
            const previewCanvas = document.getElementById('previewCanvas');
            const previewSelector = document.getElementById('previewSelector');
            const watermarkText = document.getElementById('watermarkText');
            const textSize = document.getElementById('textSize');
            const textSizeValue = document.getElementById('textSizeValue');
            const fontFamily = document.getElementById('fontFamily');
            const textColor = document.getElementById('textColor');
            const colorPreview = document.getElementById('colorPreview');
            const textOpacity = document.getElementById('textOpacity');
            const textOpacityValue = document.getElementById('textOpacityValue');
            const textShadow = document.getElementById('textShadow');
            const watermarkImageInput = document.getElementById('watermarkImageInput');
            const watermarkImagePreview = document.getElementById('watermarkImagePreview');
            const imageOpacity = document.getElementById('imageOpacity');
            const imageOpacityValue = document.getElementById('imageOpacityValue');
            const imageSize = document.getElementById('imageSize');
            const imageSizeValue = document.getElementById('imageSizeValue');
            const positionOptions = document.querySelectorAll('.position-option');
            const watermarkMargin = document.getElementById('watermarkMargin');
            const watermarkMarginValue = document.getElementById('watermarkMarginValue');
            const watermarkRotation = document.getElementById('watermarkRotation');
            const watermarkRotationValue = document.getElementById('watermarkRotationValue');
            const tileModeEnabled = document.getElementById('tileModeEnabled');
            const maintainAspectRatio = document.getElementById('maintainAspectRatio');
            const applyWatermarkBtn = document.getElementById('applyWatermarkBtn');
            const fileFormat = document.getElementById('fileFormat');
            const outputQuality = document.getElementById('outputQuality');
            const outputQualityValue = document.getElementById('outputQualityValue');
            const fileNamePrefix = document.getElementById('fileNamePrefix');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const processedCount = document.getElementById('processedCount');
            const totalCount = document.getElementById('totalCount');
            const removeWatermarkImage = document.getElementById('removeWatermarkImage');
            
            // 初始化事件监听
            uploadBtn.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleImageUpload);
            dropArea.addEventListener('dragover', handleDragOver);
            dropArea.addEventListener('dragleave', handleDragLeave);
            dropArea.addEventListener('drop', handleDrop);
            previewSelector.addEventListener('change', updatePreview);
            
            // 水印设置事件监听
            textSize.addEventListener('input', updateTextSizeValue);
            textOpacity.addEventListener('input', updateTextOpacityValue);
            textColor.addEventListener('input', updateColorPreview);
            
            imageOpacity.addEventListener('input', updateImageOpacityValue);
            imageSize.addEventListener('input', updateImageSizeValue);
            
            watermarkMargin.addEventListener('input', updateMarginValue);
            watermarkRotation.addEventListener('input', updateRotationValue);
            
            watermarkImageInput.addEventListener('change', handleWatermarkImageUpload);
            removeWatermarkImage.addEventListener('click', removeWatermarkImageHandler);
            
            positionOptions.forEach(option => {
                option.addEventListener('click', selectPosition);
            });
            
            // 按钮点击事件
            applyWatermarkBtn.addEventListener('click', applyWatermarkToAll);
            downloadAllBtn.addEventListener('click', downloadAllImages);
            
            // 水印变化时更新预览
            const watermarkControls = [
                watermarkText, textSize, fontFamily, textColor, textOpacity, textShadow,
                imageOpacity, imageSize, tileModeEnabled, watermarkMargin, watermarkRotation
            ];
            
            watermarkControls.forEach(control => {
                if (control) {
                    control.addEventListener('input', updatePreviewWithDelay);
                    control.addEventListener('change', updatePreviewWithDelay);
                }
            });
            
            // 初始化设置值显示
            updateTextSizeValue();
            updateTextOpacityValue();
            updateColorPreview();
            updateImageOpacityValue();
            updateImageSizeValue();
            updateMarginValue();
            updateRotationValue();
            updateOutputQualityValue();
            
            // 延迟更新预览，避免频繁渲染
            let previewUpdateTimeout;
            function updatePreviewWithDelay() {
                clearTimeout(previewUpdateTimeout);
                previewUpdateTimeout = setTimeout(updatePreview, 200);
            }
            
            // 处理拖放上传
            function handleDragOver(e) {
                e.preventDefault();
                dropArea.classList.add('dragover');
            }
            
            function handleDragLeave(e) {
                e.preventDefault();
                dropArea.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            }
            
            // 处理文件上传
            function handleImageUpload(e) {
                if (imageInput.files.length > 0) {
                    handleFiles(imageInput.files);
                }
            }
            
            function handleFiles(files) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        addImage(file);
                    }
                }
            }
            
            // 添加图片到列表
            function addImage(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const imageObj = {
                            file: file,
                            src: e.target.result,
                            img: img,
                            width: img.width,
                            height: img.height,
                            processed: false,
                            processedSrc: null
                        };
                        
                        images.push(imageObj);
                        renderImageItem(imageObj, images.length - 1);
                        updateImageCount();
                        
                        // 更新预览选择器
                        const option = document.createElement('option');
                        option.value = images.length - 1;
                        option.textContent = file.name + ` (${img.width}×${img.height})`;
                        previewSelector.appendChild(option);
                        
                        // 如果是第一张图片，自动选择它进行预览
                        if (images.length === 1) {
                            previewSelector.value = 0;
                            updatePreview();
                        }
                        
                        // 显示容器
                        imagesContainer.style.display = 'block';
                        previewContainer.style.display = 'block';
                        downloadAllBtn.disabled = false;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // 渲染图片列表项
            function renderImageItem(imageObj, index) {
                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-6 mb-3';
                col.dataset.index = index;
                
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                
                const img = document.createElement('img');
                img.className = 'image-thumbnail w-100 mb-2';
                img.src = imageObj.src;
                img.alt = '图片预览';
                
                const fileName = document.createElement('p');
                fileName.className = 'mb-1 text-truncate';
                fileName.textContent = imageObj.file.name;
                
                const dimensions = document.createElement('small');
                dimensions.className = 'text-muted d-block';
                dimensions.textContent = `${imageObj.width} × ${imageObj.height}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                removeBtn.addEventListener('click', function() {
                    removeImage(index);
                });
                
                const selectBtn = document.createElement('button');
                selectBtn.className = 'btn btn-sm btn-primary mt-2 w-100';
                selectBtn.textContent = '预览';
                selectBtn.addEventListener('click', function() {
                    previewSelector.value = index;
                    updatePreview();
                });
                
                imageItem.appendChild(img);
                imageItem.appendChild(fileName);
                imageItem.appendChild(dimensions);
                imageItem.appendChild(removeBtn);
                imageItem.appendChild(selectBtn);
                col.appendChild(imageItem);
                
                imagesList.appendChild(col);
            }
            
            // 移除图片
            function removeImage(index) {
                // 从数组中移除
                images.splice(index, 1);
                
                // 移除DOM元素
                const items = imagesList.querySelectorAll('.col-md-3');
                items[index].remove();
                
                // 更新索引
                const remainingItems = imagesList.querySelectorAll('.col-md-3');
                for (let i = 0; i < remainingItems.length; i++) {
                    remainingItems[i].dataset.index = i;
                }
                
                // 更新预览选择器
                previewSelector.innerHTML = '<option value="">选择预览图片...</option>';
                images.forEach((img, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = img.file.name + ` (${img.width}×${img.height})`;
                    previewSelector.appendChild(option);
                });
                
                // 更新计数
                updateImageCount();
                
                // 如果没有图片了，隐藏容器
                if (images.length === 0) {
                    imagesContainer.style.display = 'none';
                    previewContainer.style.display = 'none';
                    downloadAllBtn.disabled = true;
                } else if (currentPreviewIndex === index) {
                    // 如果当前预览图被删除，选择第一张
                    previewSelector.value = 0;
                    updatePreview();
                }
            }
            
            // 更新图片计数
            function updateImageCount() {
                imageCount.textContent = images.length;
            }
            
            // 更新预览
            function updatePreview() {
                if (!previewSelector.value) {
                    return;
                }
                
                const index = parseInt(previewSelector.value);
                currentPreviewIndex = index;
                const imageObj = images[index];
                
                const ctx = previewCanvas.getContext('2d');
                previewCanvas.width = imageObj.width;
                previewCanvas.height = imageObj.height;
                
                // 绘制原始图片
                ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                ctx.drawImage(imageObj.img, 0, 0);
                
                // 应用水印
                applyWatermark(ctx, previewCanvas.width, previewCanvas.height);
            }
            
            // 获取水印位置
            function getWatermarkPosition(width, height, watermarkWidth, watermarkHeight) {
                const margin = parseInt(watermarkMargin.value);
                let selectedPosition = 'center';
                
                positionOptions.forEach(option => {
                    if (option.classList.contains('selected')) {
                        selectedPosition = option.dataset.position;
                    }
                });
                
                let x, y;
                
                switch (selectedPosition) {
                    case 'topLeft':
                        x = margin;
                        y = margin;
                        break;
                    case 'topCenter':
                        x = (width - watermarkWidth) / 2;
                        y = margin;
                        break;
                    case 'topRight':
                        x = width - watermarkWidth - margin;
                        y = margin;
                        break;
                    case 'middleLeft':
                        x = margin;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'center':
                        x = (width - watermarkWidth) / 2;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'middleRight':
                        x = width - watermarkWidth - margin;
                        y = (height - watermarkHeight) / 2;
                        break;
                    case 'bottomLeft':
                        x = margin;
                        y = height - watermarkHeight - margin;
                        break;
                    case 'bottomCenter':
                        x = (width - watermarkWidth) / 2;
                        y = height - watermarkHeight - margin;
                        break;
                    case 'bottomRight':
                        x = width - watermarkWidth - margin;
                        y = height - watermarkHeight - margin;
                        break;
                    default:
                        x = (width - watermarkWidth) / 2;
                        y = (height - watermarkHeight) / 2;
                }
                
                return { x, y };
            }
            
            // 应用水印
            function applyWatermark(ctx, width, height) {
                // 获取当前激活的tab
                const activeTab = document.querySelector('#watermarkTabs .nav-link.active');
                const isTextWatermark = activeTab && activeTab.id === 'text-tab';
                
                // 获取旋转角度
                const rotation = parseInt(watermarkRotation.value) * Math.PI / 180;
                
                // 是否使用平铺模式
                const useTileMode = tileModeEnabled.checked;
                
                if (isTextWatermark) {
                    // 文字水印
                    const text = watermarkText.value || '版权所有';
                    const fontSize = parseInt(textSize.value);
                    const font = `${fontSize}px ${fontFamily.value}`;
                    
                    ctx.font = font;
                    const textWidth = ctx.measureText(text).width;
                    const textHeight = fontSize;
                    
                    // 设置文字样式
                    const opacity = parseFloat(textOpacity.value);
                    const color = textColor.value;
                    const rgba = hexToRgba(color, opacity);
                    
                    ctx.fillStyle = rgba;
                    if (textShadow.checked) {
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                        ctx.shadowBlur = 3;
                        ctx.shadowOffsetX = 1;
                        ctx.shadowOffsetY = 1;
                    } else {
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 0;
                    }
                    
                    if (useTileMode) {
                        // 平铺模式
                        const tileSize = Math.max(textWidth, textHeight) * 2;
                        const cols = Math.ceil(width / tileSize);
                        const rows = Math.ceil(height / tileSize);
                        
                        for (let i = 0; i < rows; i++) {
                            for (let j = 0; j < cols; j++) {
                                const x = j * tileSize + tileSize / 4;
                                const y = i * tileSize + tileSize / 2;
                                
                                ctx.save();
                                ctx.translate(x, y);
                                ctx.rotate(rotation);
                                ctx.fillText(text, 0, 0);
                                ctx.restore();
                            }
                        }
                    } else {
                        // 单个水印
                        const position = getWatermarkPosition(width, height, textWidth, textHeight);
                        
                        ctx.save();
                        ctx.translate(position.x + textWidth / 2, position.y + textHeight / 2);
                        ctx.rotate(rotation);
                        ctx.fillText(text, -textWidth / 2, textHeight / 4);
                        ctx.restore();
                    }
                } else if (watermarkImage) {
                    // 图片水印
                    const scaleFactor = parseFloat(imageSize.value) / 100;
                    const watermarkWidth = watermarkImage.width * scaleFactor;
                    const watermarkHeight = watermarkImage.height * scaleFactor;
                    
                    const opacity = parseFloat(imageOpacity.value);
                    
                    if (useTileMode) {
                        // 平铺模式
                        const tileWidth = watermarkWidth * 1.5;
                        const tileHeight = watermarkHeight * 1.5;
                        const cols = Math.ceil(width / tileWidth);
                        const rows = Math.ceil(height / tileHeight);
                        
                        for (let i = 0; i < rows; i++) {
                            for (let j = 0; j < cols; j++) {
                                const x = j * tileWidth;
                                const y = i * tileHeight;
                                
                                ctx.save();
                                ctx.globalAlpha = opacity;
                                ctx.translate(x + watermarkWidth / 2, y + watermarkHeight / 2);
                                ctx.rotate(rotation);
                                ctx.drawImage(watermarkImage, -watermarkWidth / 2, -watermarkHeight / 2, watermarkWidth, watermarkHeight);
                                ctx.restore();
                            }
                        }
                    } else {
                        // 单个水印
                        const position = getWatermarkPosition(width, height, watermarkWidth, watermarkHeight);
                        
                        ctx.save();
                        ctx.globalAlpha = opacity;
                        ctx.translate(position.x + watermarkWidth / 2, position.y + watermarkHeight / 2);
                        ctx.rotate(rotation);
                        ctx.drawImage(watermarkImage, -watermarkWidth / 2, -watermarkHeight / 2, watermarkWidth, watermarkHeight);
                        ctx.restore();
                    }
                }
            }
            
            // 重置进度条
            function resetProgressBar() {
                progressBar.style.width = '0%';
                progressBar.classList.remove('bg-danger', 'bg-warning');
                progressBar.classList.add('progress-bar-striped', 'progress-bar-animated', 'bg-primary');
                processedCount.textContent = '0';
                progressStatus.textContent = '准备处理...';
            }
            
            // 应用水印到所有图片
            function applyWatermarkToAll() {
                if (images.length === 0) {
                    alert('请先上传图片！');
                    return;
                }
                
                const activeTab = document.querySelector('#watermarkTabs .nav-link.active');
                const isTextWatermark = activeTab && activeTab.id === 'text-tab';
                
                if (!isTextWatermark && !watermarkImage) {
                    alert('请先上传水印图片！');
                    return;
                }
                
                // 显示进度条并重置状态
                progressContainer.style.display = 'block';
                resetProgressBar();
                
                totalCount.textContent = images.length;
                
                let processed = 0;
                
                // 批量处理图片
                for (let i = 0; i < images.length; i++) {
                    const imageObj = images[i];
                    
                    // 创建离屏画布
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    if (maintainAspectRatio.checked) {
                        canvas.width = imageObj.width;
                        canvas.height = imageObj.height;
                    } else {
                        // 限制最大尺寸，避免内存问题
                        const maxSize = 2000;
                        const aspectRatio = imageObj.width / imageObj.height;
                        
                        if (imageObj.width > imageObj.height && imageObj.width > maxSize) {
                            canvas.width = maxSize;
                            canvas.height = maxSize / aspectRatio;
                        } else if (imageObj.height > maxSize) {
                            canvas.height = maxSize;
                            canvas.width = maxSize * aspectRatio;
                        } else {
                            canvas.width = imageObj.width;
                            canvas.height = imageObj.height;
                        }
                    }
                    
                    // 绘制原始图片
                    ctx.drawImage(imageObj.img, 0, 0, canvas.width, canvas.height);
                    
                    // 应用水印
                    applyWatermark(ctx, canvas.width, canvas.height);
                    
                    // 转换为DataURL
                    const format = fileFormat.value;
                    const quality = parseFloat(outputQuality.value);
                    const dataURL = canvas.toDataURL(`image/${format}`, quality);
                    
                    // 保存处理结果
                    imageObj.processed = true;
                    imageObj.processedSrc = dataURL;
                    
                    // 更新进度
                    processed++;
                    const percentage = (processed / images.length) * 100;
                    progressBar.style.width = `${percentage}%`;
                    processedCount.textContent = processed;
                    
                    // 更新UI
                    if (processed === images.length) {
                        downloadAllBtn.disabled = false;
                        progressStatus.textContent = '处理完成！可以下载所有图片。';
                        progressBar.classList.remove('progress-bar-animated');
                    }
                }
                
                // 更新当前预览
                updatePreview();
            }
            
            // 下载所有处理后的图片
            function downloadAllImages() {
                if (images.length === 0) {
                    alert('没有可下载的图片！');
                    return;
                }
                
                const unprocessed = images.filter(img => !img.processed);
                if (unprocessed.length > 0) {
                    if (confirm('有' + unprocessed.length + '张图片尚未处理。是否先应用水印？')) {
                        applyWatermarkToAll();
                        return;
                    }
                }
                
                const processedImages = images.filter(img => img.processed);
                if (processedImages.length === 0) {
                    alert('没有已处理的图片！请先应用水印。');
                    return;
                }
                
                const prefix = fileNamePrefix.value || 'watermarked_';
                const extension = fileFormat.value === 'jpeg' ? 'jpg' : fileFormat.value;
                
                // 单张下载还是打包下载
                if (processedImages.length === 1) {
                    // 单张下载
                    const image = processedImages[0];
                    const fileName = `${prefix}${image.file.name.split('.')[0]}.${extension}`;
                    downloadSingleImage(image.processedSrc, fileName);
                } else {
                    // 打包下载
                    downloadAllAsZip(processedImages, prefix, extension);
                }
            }
            
            // 下载单张图片
            function downloadSingleImage(dataURL, fileName) {
                // 将dataURL转换为Blob
                fetch(dataURL)
                    .then(res => res.blob())
                    .then(blob => {
                        // 使用FileSaver.js下载
                        window.saveAs(blob, fileName);
                    })
                    .catch(error => {
                        console.error('下载单张图片出错:', error);
                        alert('下载出错，请重试！');
                    });
            }
            
            // 打包下载所有图片
            function downloadAllAsZip(images, prefix, extension) {
                // 显示进度并重置状态
                progressContainer.style.display = 'block';
                resetProgressBar();
                
                totalCount.textContent = images.length;
                progressStatus.textContent = '准备打包...';
                
                try {
                    const zip = new JSZip();
                    let count = 0;
                    
                    // 添加图片到压缩包
                    images.forEach((image, index) => {
                        const fileName = `${prefix}${image.file.name.split('.')[0]}.${extension}`;
                        
                        // 将dataURL转换为Blob
                        fetch(image.processedSrc)
                            .then(res => res.blob())
                            .then(blob => {
                                zip.file(fileName, blob);
                                count++;
                                
                                // 更新进度
                                const percentage = (count / images.length) * 100;
                                progressBar.style.width = `${percentage}%`;
                                processedCount.textContent = count;
                                
                                // 所有文件添加完成后生成zip
                                if (count === images.length) {
                                    progressStatus.textContent = '正在生成ZIP文件...';
                                    
                                    zip.generateAsync({ 
                                        type: 'blob',
                                        compression: 'DEFLATE',
                                        compressionOptions: {
                                            level: 6 // 压缩级别：1(最快)~9(最佳压缩)，6是折中选择
                                        }
                                    })
                                    .then(function(content) {
                                        // 使用正确的saveAs函数
                                        window.saveAs(content, `${prefix}watermarked_images.zip`);
                                        progressStatus.textContent = 'ZIP文件已生成，开始下载！';
                                        setTimeout(() => {
                                            progressBar.classList.remove('progress-bar-animated');
                                        }, 2000);
                                    })
                                    .catch(error => {
                                        console.error('Error generating ZIP:', error);
                                        progressStatus.textContent = '生成ZIP文件时出错，请重试！';
                                        progressBar.classList.remove('progress-bar-animated');
                                        progressBar.classList.add('bg-danger');
                                        alert('生成ZIP文件时出错: ' + error.message);
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error processing image:', error);
                                count++;
                                
                                // 更新进度，但标记有错误
                                const percentage = (count / images.length) * 100;
                                progressBar.style.width = `${percentage}%`;
                                processedCount.textContent = count;
                                
                                if (!progressBar.classList.contains('bg-danger')) {
                                    progressBar.classList.add('bg-warning');
                                    progressStatus.textContent += ' (部分图片处理失败)';
                                }
                                
                                // 仍然继续处理其他图片
                                if (count === images.length) {
                                    progressStatus.textContent = '正在生成ZIP文件...';
                                    
                                    zip.generateAsync({ 
                                        type: 'blob',
                                        compression: 'DEFLATE',
                                        compressionOptions: {
                                            level: 6
                                        }
                                    })
                                    .then(function(content) {
                                        window.saveAs(content, `${prefix}watermarked_images.zip`);
                                        progressStatus.textContent = 'ZIP文件已生成，开始下载！ (部分图片可能处理失败)';
                                        setTimeout(() => {
                                            progressBar.classList.remove('progress-bar-animated');
                                        }, 2000);
                                    })
                                    .catch(error => {
                                        console.error('Error generating ZIP:', error);
                                        progressStatus.textContent = '生成ZIP文件时出错，请重试！';
                                        progressBar.classList.remove('progress-bar-animated');
                                        progressBar.classList.add('bg-danger');
                                        alert('生成ZIP文件时出错: ' + error.message);
                                    });
                                }
                            });
                    });
                } catch (error) {
                    console.error('ZIP初始化错误:', error);
                    progressStatus.textContent = '打包过程初始化失败，请重试！';
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    alert('打包初始化失败: ' + error.message);
                }
            }
            
            // 处理水印图片上传
            function handleWatermarkImageUpload(e) {
                if (watermarkImageInput.files.length === 0) return;
                
                const file = watermarkImageInput.files[0];
                if (!file.type.startsWith('image/')) {
                    alert('请选择图片文件！');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        watermarkImage = img;
                        
                        // 显示预览
                        watermarkImagePreview.style.display = 'block';
                        watermarkImagePreview.querySelector('img').src = e.target.result;
                        
                        // 更新预览
                        updatePreview();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // 移除水印图片
            function removeWatermarkImageHandler() {
                watermarkImage = null;
                watermarkImageInput.value = '';
                watermarkImagePreview.style.display = 'none';
                updatePreview();
            }
            
            // 选择水印位置
            function selectPosition() {
                positionOptions.forEach(option => {
                    option.classList.remove('selected');
                });
                this.classList.add('selected');
                updatePreview();
            }
            
            // 数值显示更新函数
            function updateTextSizeValue() {
                textSizeValue.textContent = `${textSize.value}px`;
                updatePreview();
            }
            
            function updateTextOpacityValue() {
                textOpacityValue.textContent = `${Math.round(textOpacity.value * 100)}%`;
                updatePreview();
            }
            
            function updateColorPreview() {
                const opacity = parseFloat(textOpacity.value);
                const rgba = hexToRgba(textColor.value, opacity);
                colorPreview.style.backgroundColor = rgba;
                updatePreview();
            }
            
            function updateImageOpacityValue() {
                imageOpacityValue.textContent = `${Math.round(imageOpacity.value * 100)}%`;
                updatePreview();
            }
            
            function updateImageSizeValue() {
                imageSizeValue.textContent = `${imageSize.value}%`;
                updatePreview();
            }
            
            function updateMarginValue() {
                watermarkMarginValue.textContent = `${watermarkMargin.value}px`;
                updatePreview();
            }
            
            function updateRotationValue() {
                watermarkRotationValue.textContent = `${watermarkRotation.value}°`;
                updatePreview();
            }
            
            function updateOutputQualityValue() {
                outputQualityValue.textContent = `${Math.round(outputQuality.value * 100)}%`;
            }
            
            // 辅助函数
            function hexToRgba(hex, alpha) {
                const r = parseInt(hex.substring(1, 3), 16);
                const g = parseInt(hex.substring(3, 5), 16);
                const b = parseInt(hex.substring(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            
            outputQuality.addEventListener('input', updateOutputQualityValue);
        });
    </script>
</body>
</html> 