<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片转PDF - 工具箱</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-tools me-2"></i>工具箱
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#popular">热门工具</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#all-tools">全部工具</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#about">关于我们</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 页面内容 -->
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="mb-3"><i class="bi bi-file-earmark-pdf me-2 text-danger"></i>图片转PDF</h1>
                <p class="lead">将多张图片合并为一个PDF文件</p>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html">首页</a></li>
                        <li class="breadcrumb-item"><a href="../pdf-tools.html">PDF处理工具</a></li>
                        <li class="breadcrumb-item active" aria-current="page">图片转PDF</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <input type="file" id="imageUpload" accept="image/*" multiple class="form-control mb-3">
                        <div id="previewArea" class="mb-3"></div>
                        <button id="convertToPdfBtn" class="btn btn-primary">开始转换</button>
                        <button id="loadingBtn" class="btn btn-primary d-none" disabled>
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            处理中...
                        </button>
                        <a id="downloadPdfLink" href="#" class="btn btn-success mt-3" style="display: none;">下载PDF</a>
                        <div id="errorMsg" class="alert alert-danger mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="bi bi-tools me-2"></i>工具箱</h5>
                    <p>一站式在线工具平台，免费、高效、便捷</p>
                </div>
                <div class="col-md-3">
                    <h5>链接</h5>
                    <ul class="list-unstyled">
                        <li><a href="../index.html" class="text-white">首页</a></li>
                        <li><a href="../index.html#popular" class="text-white">热门工具</a></li>
                        <li><a href="../index.html#all-tools" class="text-white">全部工具</a></li>
                        <li><a href="../index.html#about" class="text-white">关于我们</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>联系我们</h5>
                    <ul class="list-unstyled">
                        <li><a href="mailto:contact@toolbox.com" class="text-white">contact@toolbox.com</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p>&copy; 2023 工具箱. 保留所有权利.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const convertButton = document.getElementById('convertToPdfBtn');
            const loadingButton = document.getElementById('loadingBtn');
            const imageUpload = document.getElementById('imageUpload');
            const downloadLink = document.getElementById('downloadPdfLink');
            const previewArea = document.getElementById('previewArea');
            const errorMsg = document.getElementById('errorMsg');

            // 尝试使用多种PDF库
            let useJsPDF = true; // 默认使用jsPDF库

            if (typeof PDFLib === 'undefined' && typeof jspdf === 'undefined') {
                showError('PDF库加载失败，请刷新页面再试');
                return;
            }

            if (typeof PDFLib !== 'undefined') {
                console.log('PDFLib库已加载');
            } else {
                console.log('PDFLib库未加载');
            }
            
            if (typeof jspdf !== 'undefined') {
                console.log('jsPDF库已加载');
            } else {
                console.log('jsPDF库未加载');
            }

            imageUpload.addEventListener('change', function() {
                previewArea.innerHTML = '';
                errorMsg.style.display = 'none';
                downloadLink.style.display = 'none';
                
                const files = imageUpload.files;
                if (files.length === 0) return;
                
                const previewContainer = document.createElement('div');
                previewContainer.className = 'd-flex flex-wrap justify-content-center';
                
                for (const file of files) {
                    if (!file.type.match('image.*')) {
                        showError('请只上传图片文件');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'm-2 text-center';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.maxWidth = '100px';
                        img.style.maxHeight = '100px';
                        img.className = 'img-thumbnail';
                        
                        const fileName = document.createElement('div');
                        fileName.className = 'small text-muted mt-1';
                        fileName.textContent = file.name;
                        
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(fileName);
                        previewContainer.appendChild(imgContainer);
                    };
                    reader.readAsDataURL(file);
                }
                
                previewArea.appendChild(previewContainer);
            });

            convertButton.addEventListener('click', async function() {
                const files = imageUpload.files;
                if (files.length === 0) {
                    showError('请选择至少一张图片');
                    return;
                }

                // 显示加载状态
                convertButton.classList.add('d-none');
                loadingButton.classList.remove('d-none');
                errorMsg.style.display = 'none';
                downloadLink.style.display = 'none';

                try {
                    // 使用jsPDF库来创建PDF (更简单、更可靠)
                    const doc = new jspdf.jsPDF();
                    let successCount = 0;

                    // 加载所有图片并获取它们的DataURL
                    const imageDataURLs = await Promise.all(
                        Array.from(files).map(file => 
                            new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve({
                                    name: file.name,
                                    dataURL: e.target.result
                                });
                                reader.onerror = () => resolve(null);
                                reader.readAsDataURL(file);
                            })
                        )
                    );

                    // 按顺序处理每个图片
                    for (let i = 0; i < imageDataURLs.length; i++) {
                        const imageData = imageDataURLs[i];
                        if (!imageData) continue;

                        try {
                            console.log(`处理图片 ${i+1}/${imageDataURLs.length}: ${imageData.name}`);
                            
                            // 如果不是第一页，添加新页
                            if (successCount > 0) {
                                doc.addPage();
                            }

                            // 创建图像对象来获取尺寸
                            const img = new Image();
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                img.src = imageData.dataURL;
                            });

                            // 计算适合页面的图像尺寸
                            const pageWidth = doc.internal.pageSize.getWidth();
                            const pageHeight = doc.internal.pageSize.getHeight();
                            
                            const imgRatio = img.width / img.height;
                            const pageRatio = pageWidth / pageHeight;
                            
                            let imgWidth, imgHeight;
                            
                            if (imgRatio > pageRatio) {
                                // 图像更宽，以宽度为约束
                                imgWidth = pageWidth * 0.9;
                                imgHeight = imgWidth / imgRatio;
                            } else {
                                // 图像更高，以高度为约束
                                imgHeight = pageHeight * 0.9;
                                imgWidth = imgHeight * imgRatio;
                            }
                            
                            // 计算居中位置
                            const x = (pageWidth - imgWidth) / 2;
                            const y = (pageHeight - imgHeight) / 2;
                            
                            // 添加图像到PDF
                            doc.addImage(
                                imageData.dataURL, 
                                'JPEG', 
                                x, 
                                y, 
                                imgWidth, 
                                imgHeight
                            );
                            
                            successCount++;
                        } catch (err) {
                            console.error(`处理图片 ${imageData.name} 时出错:`, err);
                        }
                    }

                    if (successCount === 0) {
                        throw new Error('无法处理任何图片，请检查图片格式');
                    }

                    // 生成PDF并创建下载链接
                    const pdfBlob = doc.output('blob');
                    const url = URL.createObjectURL(pdfBlob);
                    
                    downloadLink.href = url;
                    downloadLink.download = '图片合并.pdf';
                    downloadLink.style.display = 'inline-block';
                    
                    // 在页面内预览
                    const pdfPreview = document.createElement('iframe');
                    pdfPreview.src = url;
                    pdfPreview.width = '100%';
                    pdfPreview.height = '500px';
                    pdfPreview.style.marginTop = '20px';
                    pdfPreview.className = 'border';
                    
                    previewArea.innerHTML = '';
                    previewArea.appendChild(pdfPreview);
                    
                } catch (error) {
                    console.error('PDF生成失败:', error);
                    showError('PDF生成失败: ' + error.message);
                } finally {
                    // 恢复按钮状态
                    convertButton.classList.remove('d-none');
                    loadingButton.classList.add('d-none');
                }
            });
            
            // 显示错误信息
            function showError(message) {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            }
        });
    </script>
</body>
</html> 